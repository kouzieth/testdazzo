<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jackpot DApp</title>
  <style>
    body {
      background: #0e0e0e;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    #connect-btn {
      background: #ff9800;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 20px;
    }
    #player-entries {
      margin: 20px auto;
      max-width: 400px;
      background: #1a1a1a;
      padding: 15px;
      border-radius: 12px;
      min-height: 100px;
    }
    .player-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 10px;
      margin: 4px 0;
      background: #2a2a2a;
      border-radius: 6px;
    }
    .player-address {
      font-weight: bold;
    }
    .player-bet {
      color: #ff9800;
    }
    #countdown {
      margin-top: 10px;
      font-size: 20px;
      color: #ccc;
    }
    /* Spinner */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .loading-spinner div {
      width: 24px;
      height: 24px;
      border: 3px solid #666;
      border-top: 3px solid #ff9800;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Fade */
    .fade { opacity: 0; transition: opacity 0.4s ease-in-out; }
    .fade.show { opacity: 1; }
    /* Winner Highlight */
    .winner-highlight {
      animation: glowWinner 2s ease-in-out 2, scalePop 0.6s ease-out;
    }
    @keyframes glowWinner {
      0% { box-shadow: 0 0 0px rgba(255, 215, 0, 0); }
      50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.9); }
      100% { box-shadow: 0 0 0px rgba(255, 215, 0, 0); }
    }
    @keyframes scalePop {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    /* Carousel Winners */
    #winner-carousel {
      margin: 20px auto;
      max-width: 400px;
      background: #222;
      padding: 15px;
      border-radius: 12px;
    }
    .carousel-item {
      padding: 10px;
      margin: 6px 0;
      background: #333;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>üé∞ Jackpot DApp</h1>
  <button id="connect-btn">Connect Wallet</button>

  <div id="player-entries">
    <div style="padding:1rem; color:#888;">Connect wallet to load players</div>
  </div>
  <div>Players: <span id="player-count">0</span></div>
  <div id="countdown">00:00</div>

  <h2>üèÜ Winners</h2>
  <div id="winner-carousel">
    <div style="padding:1rem; color:#888;">No winners yet</div>
  </div>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";
    import { EthereumClient, w3mConnectors, w3mProvider } from "https://cdn.jsdelivr.net/npm/@web3modal/ethereum@2.6.2";
    import { Web3Modal } from "https://cdn.jsdelivr.net/npm/@web3modal/html@2.6.2";

    // üîπ Pakai Project ID dari Reown
    const projectId = "400db8559bcc1daaf0569133ef5198bd"; 

    // üîπ Chain ‚Üí Sepolia (karena kontrakmu testnet, bukan mainnet)
    const chains = [{ id: 11155111, name: "Sepolia Testnet" }];

    const ethereumClient = new EthereumClient(
      w3mConnectors({ projectId, version: 2, chains }),
      chains,
      w3mProvider({ projectId, chains })
    );
    const web3modal = new Web3Modal({ projectId, themeMode: "dark" }, ethereumClient);

    let provider, signer, contract;
    let currentRoundId = "0";

    const connectBtn = document.getElementById("connect-btn");
    const playerEntries = document.getElementById("player-entries");
    const playerCount = document.getElementById("player-count");
    const countdownElement = document.getElementById("countdown");
    const winnerCarousel = document.getElementById("winner-carousel");

    // üîπ Contract Address kamu
    const contractAddress = "0xB4BA0d964CB4Ef4c2CEC675299e1058102435b1b"; 

    // üîπ Minimal ABI contoh (harus sesuai contract jackpot kamu)
    const contractABI = [
      "function getCurrentRoundId() view returns (uint256)",
      "function getRoundPlayers(uint256) view returns (address[])",
      "function getPlayerBet(uint256,address) view returns (uint256)",
      "event BetPlaced(uint256 indexed roundId, address indexed player, uint256 amount)",
      "event RoundEnded(uint256 indexed roundId, address indexed winner, uint256 totalPot)",
      "event RoundStarted(uint256 indexed roundId, uint256 startTime)"
    ];

    connectBtn.addEventListener("click", async () => {
      try {
        await web3modal.openModal();
        const walletProvider = await ethereumClient.getProvider();
        provider = new ethers.providers.Web3Provider(walletProvider);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);

        connectBtn.innerText = "Connected ‚úÖ";
        initGame();
      } catch (err) {
        console.error("Wallet connect error:", err);
      }
    });

    async function loadCurrentRound() {
      currentRoundId = (await contract.getCurrentRoundId()).toString();
      console.log("Current round:", currentRoundId);
    }

    async function updatePlayerList() {
      if (!contract) return;
      try {
        const players = await contract.getRoundPlayers(currentRoundId);
        if (players.length === 0) {
          playerEntries.innerHTML = `<div style="padding:1rem; color:#888;">No players yet</div>`;
          playerCount.textContent = "0";
          return;
        }
        let html = "";
        for (const player of players) {
          const betAmount = await contract.getPlayerBet(currentRoundId, player);
          const formatted = parseFloat(ethers.utils.formatEther(betAmount)).toFixed(4);
          html += `
            <div class="player-row fade show">
              <div class="player-address">${player.substring(0,6)}...${player.substring(player.length-4)}</div>
              <div class="player-bet">${formatted} ETH</div>
            </div>`;
        }
        playerEntries.innerHTML = html;
        playerCount.textContent = players.length.toString();
      } catch(e) {
        console.error("Error updating player list", e);
      }
    }

    async function updateCarousel() {
      winnerCarousel.innerHTML = `
        <div class="carousel-item">üéâ Winner just added (dummy)</div>
      `;
    }

    function setupEventListeners() {
      if (!contract) return;

      contract.on("BetPlaced", (roundId, player, amount) => {
        if (roundId.toString() === currentRoundId.toString()) {
          updatePlayerList();
        }
      });

      contract.on("RoundEnded", async (roundId, winner, totalPot) => {
        if (roundId.toString() === currentRoundId.toString()) {
          await updateCarousel();
          const items = document.querySelectorAll(".carousel-item");
          if (items.length > 0) {
            const latest = items[0];
            latest.classList.add("winner-highlight");
            setTimeout(() => latest.classList.remove("winner-highlight"), 4000);
          }
          startNewRound();
        }
      });

      contract.on("RoundStarted", (roundId) => {
        currentRoundId = roundId.toString();
        updatePlayerList();
      });
    }

    async function startNewRound() {
      try {
        playerEntries.classList.remove("show");
        playerEntries.classList.add("fade");
        setTimeout(() => {
          playerEntries.innerHTML = `<div class="loading-spinner"><div></div></div>`;
          playerCount.textContent = "0";
          countdownElement.textContent = "00:00";
          playerEntries.classList.add("show");
        }, 200);

        await new Promise(r => setTimeout(r, 1200));
        await loadCurrentRound();
        await updatePlayerList();
        playerEntries.classList.add("show");
      } catch(e) {
        console.error("Error new round", e);
      }
    }

    async function initGame() {
      await loadCurrentRound();
      await updatePlayerList();
      await updateCarousel();
      setupEventListeners();
    }
  </script>
</body>
</html>
